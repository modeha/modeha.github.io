<!DOCTYPE html>
<html lang="en"><head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Deep Learning" /></head>
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<style>@import url(/public/css/syntax/monokai.css);</style>
  <title>Deep Learning</title>
  <!-- <link href="/public/css/bootstrap.min.css" rel="stylesheet"> -->

  <link href="/public/css/style.css" rel="stylesheet">
  <body>
  	<div class="container"> 
		<div class="sidebar">
			<div class="sidebar-item sidebar-header">
	<div class='sidebar-brand'>
		<a href="/about/">Deep Learning</a>
	</div>
	<p class="lead">A blog exploring deep learning, AI, and data science topics by Mohsen Dehghani.</p></div>

<div class="sidebar-item sidebar-nav">
	<ul class="nav">
      <li class="nav-title">Pages</li>
	  <li>
	  	<a class="nav-item" href="/">Articles</a>
	  </li>
	  
	  
	    
	  
	    
	      
	        <li>
	        	<a class="nav-item" href="/about/">
	            	About
	            </a>
	        </li>
	      
	    
	  
	    
	      
	    
	  
	    
	  
	    
	  
	    
	  
	</ul>
</div>

<div class="sidebar-item sidebar-nav">
  	<ul class="nav">
			<li class="nav-title">Categories</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#Update">
				<span class="name">Update</span>
				<span class="badge">13</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#Jekyll">
				<span class="name">Jekyll</span>
				<span class="badge">1</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#update">
				<span class="name">update</span>
				<span class="badge">6</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#math">
				<span class="name">math</span>
				<span class="badge">1</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#data-science">
				<span class="name">data-science</span>
				<span class="badge">1</span>
	    	</a>
 		</li>
	    
	  </nav>
	</ul>
</div>

<div class="sidebar-item sidebar-footer">
	<p>Powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a></p>
</div>
		</div>
		<div class="content">
			<article class="post">
	<header class="post-header">
		<div class="post-title"> 
			Handwritten Text Recognition
		</div>
		<time class="post-date dt-published" datetime="2025-01-25T13:06:00-05:00" itemprop="datePublished">2025/01/25
		</time>		
	</header>

	<div class="post-content">
		<h2 id="handwritten-text-recognition"><strong>Handwritten Text Recognition</strong></h2>

<hr />
<p>Handwritten Text Recognition with Tensorflow2 &amp; Keras &amp; IAM Dataset.</p>

<p>Convolutional Recurrent Neural Network. CTC.</p>

<p>Author : Mohsen Dehghani</p>

<h2 id="dataset-used">Dataset used:</h2>

<p>Used in this project: <a href="http://www.fki.inf.unibe.ch/DBs/iamDB/data/words/">IAM Dataset</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">keras.preprocessing.sequence</span> <span class="kn">import</span> <span class="n">pad_sequences</span>

<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Reshape</span><span class="p">,</span> <span class="n">BatchNormalization</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPool2D</span><span class="p">,</span> <span class="n">Lambda</span><span class="p">,</span> <span class="n">Bidirectional</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">keras.activations</span> <span class="kn">import</span> <span class="n">relu</span><span class="p">,</span> <span class="n">sigmoid</span><span class="p">,</span> <span class="n">softmax</span>
<span class="kn">import</span> <span class="nn">keras.backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">keras_tqdm</span> <span class="kn">import</span> <span class="n">TQDMNotebookCallback</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPool2D</span><span class="p">,</span> <span class="n">BatchNormalization</span><span class="p">,</span> <span class="n">Lambda</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Bidirectional</span><span class="p">,</span> <span class="n">LSTM</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'./data/words2.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>

<span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">]</span> 
<span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">lines</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># Define the portion (e.g., 10%)
</span><span class="n">portion</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">num_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">portion</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>

<span class="c1"># Randomly select 10% of the lines
</span><span class="n">lines_subset</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>

<span class="n">lines</span> <span class="o">=</span> <span class="n">lines_subset</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Original size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="si">}</span><span class="s">, Subset size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lines_subset</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">max_label_len</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">char_list</span> <span class="o">=</span> <span class="s">"!</span><span class="se">\"</span><span class="s">#&amp;'()*+,-./0123456789:;?ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"</span> 

<span class="c1"># string.ascii_letters + string.digits (Chars &amp; Digits)
# or 
# "!\"#&amp;'()*+,-./0123456789:;?ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
</span>
<span class="k">print</span><span class="p">(</span><span class="n">char_list</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">char_list</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">encode_to_labels</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="c1"># encoding each output word into digits
</span>    <span class="n">dig_lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">chara</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
        <span class="n">dig_lst</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_list</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">chara</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">dig_lst</span>

<span class="k">def</span> <span class="nf">decode_to_labels</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
    <span class="s">"""
    Decodes a list of indices back to the corresponding string using char_list.

    Args:
        indices (list of int): List of indices representing encoded characters.

    Returns:
        str: Decoded string.
    """</span>
    <span class="n">decoded_str</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">char_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">decoded_str</span>

<span class="c1"># Example Usage
</span><span class="n">encoded_example</span> <span class="o">=</span> <span class="n">encode_to_labels</span><span class="p">(</span><span class="s">"Hello123"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Encoded:"</span><span class="p">,</span> <span class="n">encoded_example</span><span class="p">)</span>

<span class="n">decoded_example</span> <span class="o">=</span> <span class="n">decode_to_labels</span><span class="p">(</span><span class="n">encoded_example</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Decoded:"</span><span class="p">,</span> <span class="n">decoded_example</span><span class="p">)</span>
<span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">RECORDS_COUNT</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="n">train_images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_input_length</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_label_length</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_original_text</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">valid_images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">valid_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">valid_input_length</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">valid_label_length</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">valid_original_text</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">inputs_length</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">labels_length</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">def</span> <span class="nf">process_image</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="s">"""
    Converts image to shape (32, 128, 1) &amp; normalize
    """</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>

    <span class="c1"># Aspect Ratio Calculation
</span>    <span class="n">new_w</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">new_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">new_w</span> <span class="o">/</span> <span class="n">w</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span><span class="p">))</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
    
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
    
    <span class="c1"># Converts each to (32, 128, 1)
</span>    <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>
        <span class="n">add_zeros</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">full</span><span class="p">((</span><span class="mi">32</span><span class="o">-</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="mi">255</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">img</span><span class="p">,</span> <span class="n">add_zeros</span><span class="p">))</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
    
    <span class="k">if</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">:</span>
        <span class="n">add_zeros</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">full</span><span class="p">((</span><span class="n">w</span><span class="p">,</span> <span class="mi">128</span><span class="o">-</span><span class="n">h</span><span class="p">),</span> <span class="mi">255</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">img</span><span class="p">,</span> <span class="n">add_zeros</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
        
    <span class="k">if</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mi">128</span> <span class="ow">or</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
    
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
    
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># Normalize 
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">/</span> <span class="mi">255</span>
    
    <span class="k">return</span> <span class="n">img</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s">'ok'</span><span class="p">:</span>
        <span class="n">word_id</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">word</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">8</span><span class="p">:])</span>
                
        <span class="n">splits_id</span> <span class="o">=</span> <span class="n">word_id</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'-'</span><span class="p">)</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="s">'words/{}/{}-{}/{}.png'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">splits_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                                  <span class="n">splits_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                                  <span class="n">splits_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                                                  <span class="n">word_id</span><span class="p">)</span>
        
        <span class="c1"># process image
</span>        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'./data/'</span><span class="o">+</span><span class="n">filepath</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">process_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="c1"># process label
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">encode_to_labels</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="k">if</span> <span class="n">index</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">valid_images</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">valid_labels</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">valid_input_length</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span>
            <span class="n">valid_label_length</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
            <span class="n">valid_original_text</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">train_images</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">train_labels</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">train_input_length</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span>
            <span class="n">train_label_length</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
            <span class="n">train_original_text</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_label_len</span><span class="p">:</span>
            <span class="n">max_label_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">RECORDS_COUNT</span><span class="p">:</span>
        <span class="k">break</span>
<span class="c1"># Print subset shapes to verify
</span><span class="k">print</span><span class="p">(</span><span class="s">"Subset shapes:"</span><span class="p">,</span> 
      <span class="nb">len</span><span class="p">(</span><span class="n">train_images</span><span class="p">),</span> 
      <span class="nb">len</span><span class="p">(</span><span class="n">train_labels</span><span class="p">),</span> 
      <span class="nb">len</span><span class="p">(</span><span class="n">valid_images</span><span class="p">),</span> 
      <span class="nb">len</span><span class="p">(</span><span class="n">valid_labels</span><span class="p">))</span>
<span class="n">train_padded_label</span> <span class="o">=</span> <span class="n">pad_sequences</span><span class="p">(</span><span class="n">train_labels</span><span class="p">,</span> 
                             <span class="n">maxlen</span><span class="o">=</span><span class="n">max_label_len</span><span class="p">,</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s">'post'</span><span class="p">,</span>
                             <span class="n">value</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">char_list</span><span class="p">))</span>

<span class="n">valid_padded_label</span> <span class="o">=</span> <span class="n">pad_sequences</span><span class="p">(</span><span class="n">valid_labels</span><span class="p">,</span> 
                             <span class="n">maxlen</span><span class="o">=</span><span class="n">max_label_len</span><span class="p">,</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s">'post'</span><span class="p">,</span>
                             <span class="n">value</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">char_list</span><span class="p">))</span>

<span class="n">train_images</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">train_images</span><span class="p">)</span>
<span class="n">train_input_length</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">train_input_length</span><span class="p">)</span>
<span class="n">train_label_length</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">train_label_length</span><span class="p">)</span>

<span class="n">valid_images</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">valid_images</span><span class="p">)</span>
<span class="n">valid_input_length</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">valid_input_length</span><span class="p">)</span>
<span class="n">valid_label_length</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">valid_label_length</span><span class="p">)</span>
<span class="n">train_images</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span><span class="n">train_padded_label</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span><span class="n">valid_images</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">valid_padded_label</span><span class="p">.</span><span class="n">shape</span>

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Original size: 115320, Subset size: 115320
!"#&amp;'()*+,-./0123456789:;?ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz 78
Encoded: [33, 56, 63, 63, 66, 14, 15, 16]
Decoded: Hello123
Subset shapes: 7579 7579 847 847
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># Define input shape (height=32, width=128)
</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1"># Convolutional layers
</span><span class="n">conv_1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">pool_1</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">conv_1</span><span class="p">)</span>

<span class="n">conv_2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">)(</span><span class="n">pool_1</span><span class="p">)</span>
<span class="n">pool_2</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">conv_2</span><span class="p">)</span>

<span class="n">conv_3</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">)(</span><span class="n">pool_2</span><span class="p">)</span>
<span class="n">conv_4</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">)(</span><span class="n">conv_3</span><span class="p">)</span>
<span class="n">pool_4</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))(</span><span class="n">conv_4</span><span class="p">)</span>

<span class="n">conv_5</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">)(</span><span class="n">pool_4</span><span class="p">)</span>
<span class="n">batch_norm_5</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">conv_5</span><span class="p">)</span>

<span class="n">conv_6</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">)(</span><span class="n">batch_norm_5</span><span class="p">)</span>
<span class="n">batch_norm_6</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">conv_6</span><span class="p">)</span>
<span class="n">pool_6</span> <span class="o">=</span> <span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))(</span><span class="n">batch_norm_6</span><span class="p">)</span>

<span class="n">conv_7</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">pool_6</span><span class="p">)</span>

<span class="n">squeezed</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">K</span><span class="p">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))(</span><span class="n">conv_7</span><span class="p">)</span>

<span class="c1"># Bidirectional LSTM layers
</span><span class="n">blstm_1</span> <span class="o">=</span> <span class="n">Bidirectional</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))(</span><span class="n">squeezed</span><span class="p">)</span>
<span class="n">blstm_2</span> <span class="o">=</span> <span class="n">Bidirectional</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))(</span><span class="n">blstm_1</span><span class="p">)</span>

<span class="n">outputs</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">char_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">)(</span><span class="n">blstm_2</span><span class="p">)</span>

<span class="c1"># Model for prediction
</span><span class="n">act_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

<span class="c1"># Inputs for training (additional)
</span><span class="n">the_labels</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'the_labels'</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">max_label_len</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">'float32'</span><span class="p">)</span>
<span class="n">input_length</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'input_length'</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">'int64'</span><span class="p">)</span>
<span class="n">label_length</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'label_length'</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">'int64'</span><span class="p">)</span>

<span class="c1"># Define the custom CTC loss function
</span><span class="k">def</span> <span class="nf">ctc_lambda_func</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">y_pred</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">input_length</span><span class="p">,</span> <span class="n">label_length</span> <span class="o">=</span> <span class="n">args</span>
    <span class="k">return</span> <span class="n">K</span><span class="p">.</span><span class="n">ctc_batch_cost</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">input_length</span><span class="p">,</span> <span class="n">label_length</span><span class="p">)</span>

<span class="c1"># Add the CTC loss layer
</span><span class="n">loss_out</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">ctc_lambda_func</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">name</span><span class="o">=</span><span class="s">'ctc'</span><span class="p">)([</span><span class="n">outputs</span><span class="p">,</span> <span class="n">the_labels</span><span class="p">,</span> <span class="n">input_length</span><span class="p">,</span> <span class="n">label_length</span><span class="p">])</span>

<span class="c1"># Training model with CTC loss
</span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">inputs</span><span class="p">,</span> <span class="n">the_labels</span><span class="p">,</span> <span class="n">input_length</span><span class="p">,</span> <span class="n">label_length</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">loss_out</span><span class="p">)</span>

<span class="c1"># Compile the model
</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">optimizer_name</span> <span class="o">=</span> <span class="s">'adam'</span>
<span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="p">{</span><span class="s">'ctc'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">},</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer_name</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>

<span class="c1"># Callbacks setup
</span><span class="n">model_save_path</span> <span class="o">=</span> <span class="s">"./ocr_ctc_model"</span>
<span class="n">checkpoint</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span>
    <span class="n">filepath</span><span class="o">=</span><span class="n">model_save_path</span> <span class="o">+</span> <span class="s">'/best_model.h5'</span><span class="p">,</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">save_best_only</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s">'auto'</span>
<span class="p">)</span>

<span class="n">plot_callback</span> <span class="o">=</span> <span class="n">TrainingPlot</span><span class="p">()</span>
<span class="n">callbacks_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">plot_callback</span><span class="p">]</span>

<span class="c1"># Save the model without the CTC loss for better reusability
</span><span class="n">model_without_ctc</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
<span class="n">model_without_ctc</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_save_path</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s">'tf'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Model saved successfully to </span><span class="si">{</span><span class="n">model_save_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Training with callbacks
</span><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">train_images</span><span class="p">,</span> <span class="n">train_padded_label</span><span class="p">,</span> <span class="n">train_input_length</span><span class="p">,</span> <span class="n">train_label_length</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_images</span><span class="p">)),</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> 
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span>
        <span class="p">[</span><span class="n">valid_images</span><span class="p">,</span> <span class="n">valid_padded_label</span><span class="p">,</span> <span class="n">valid_input_length</span><span class="p">,</span> <span class="n">valid_label_length</span><span class="p">],</span>
        <span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_images</span><span class="p">))]</span>
    <span class="p">),</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks_list</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Training complete. Model saved successfully."</span><span class="p">)</span>

</code></pre></div></div>
<p><img src="/assets/figures/IAM_accuracy.png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>948/948 [==============================] - 555s 585ms/step - loss: 3.0008 - accuracy: 0.3644 - val_loss: 5.7751 - val_accuracy: 0.3542
Training complete. Model saved successfully.
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>


<span class="c1"># Load the saved model without CTC for inference or re-training
</span><span class="n">loaded_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">model_save_path</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Model loaded successfully."</span><span class="p">)</span>

<span class="c1"># Re-add the CTC loss Lambda layer
</span><span class="n">loss_out</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">ctc_lambda_func</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">name</span><span class="o">=</span><span class="s">'ctc'</span><span class="p">)(</span>
    <span class="p">[</span><span class="n">loaded_model</span><span class="p">.</span><span class="n">output</span><span class="p">,</span> <span class="n">the_labels</span><span class="p">,</span> <span class="n">input_length</span><span class="p">,</span> <span class="n">label_length</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Build the complete model again with CTC loss
</span><span class="n">final_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">loaded_model</span><span class="p">.</span><span class="nb">input</span><span class="p">,</span> <span class="n">the_labels</span><span class="p">,</span> <span class="n">input_length</span><span class="p">,</span> <span class="n">label_length</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">loss_out</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"CTC layer re-added successfully."</span><span class="p">)</span>

<span class="c1"># Compile the model again with the same optimizer
</span><span class="n">final_model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="p">{</span><span class="s">'ctc'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">},</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer_name</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>

<span class="c1"># Define Callbacks for Resuming Training
</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span>
    <span class="n">filepath</span><span class="o">=</span><span class="s">"./ocr_ctc_model/best_model_resume.h5"</span><span class="p">,</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">save_best_only</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s">'auto'</span>
<span class="p">)</span>


<span class="c1"># Callbacks list
</span><span class="n">callbacks_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">plot_callback</span><span class="p">]</span>

<span class="c1"># Continue training from the last saved epoch (starting from epoch 3)
</span><span class="n">initial_epoch</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Training previously done for 2 epochs
</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">final_model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">train_images</span><span class="p">,</span> <span class="n">train_padded_label</span><span class="p">,</span> <span class="n">train_input_length</span><span class="p">,</span> <span class="n">train_label_length</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_images</span><span class="p">)),</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
    <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># Continue training till epoch 5
</span>    <span class="n">initial_epoch</span><span class="o">=</span><span class="n">initial_epoch</span><span class="p">,</span>  <span class="c1"># Start from epoch 3
</span>    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span>
        <span class="p">[</span><span class="n">valid_images</span><span class="p">,</span> <span class="n">valid_padded_label</span><span class="p">,</span> <span class="n">valid_input_length</span><span class="p">,</span> <span class="n">valid_label_length</span><span class="p">],</span>
        <span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_images</span><span class="p">))]</span>
    <span class="p">),</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks_list</span>  <span class="c1"># Including checkpointing and plotting
</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Training resumed and completed successfully."</span><span class="p">)</span>

</code></pre></div></div>

<h2 id="training-accuracy">Training Accuracy</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># predict outputs on validation images
</span><span class="n">m</span><span class="o">=</span><span class="mi">1</span>
<span class="n">prediction</span> <span class="o">=</span> <span class="n">act_model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_images</span><span class="p">[</span><span class="n">m</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
 
<span class="c1"># use CTC decoder
</span><span class="n">decoded</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="n">ctc_decode</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span>   
                       <span class="n">input_length</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="n">prediction</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">prediction</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">greedy</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>

<span class="c1"># see the results
</span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"original_text =  "</span><span class="p">,</span> <span class="n">train_original_text</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">i</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"predicted text = "</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s">''</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">char_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)],</span> <span class="n">end</span> <span class="o">=</span> <span class="s">''</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">train_images</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">i</span><span class="p">].</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">128</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">gray</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1/1 [==============================] - 0s 169ms/step
original_text =   taken
predicted text = taken
</code></pre></div></div>

<p><img src="/assets/figures/IAM_accuracy2.png" /></p>


	</div>
</article>
		</div>
	</div>
  </body>
</html>